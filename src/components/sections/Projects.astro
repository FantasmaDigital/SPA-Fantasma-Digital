---
import ProjectModal from "../ui/ProjectModal.astro";
type ProjectsProps = {
  projects: {
    id: number;
    title: string;
    description: string;
    fullDescription: string;
    technologies: string[];
    imageUrl: string;
    icon: string;
    screenshots: string[];
    site: string;
    hiddenCallout?: string;
    callout: string;
  }[];
};

const projects: ProjectsProps["projects"] = [
  {
    id: 1,
    title: "Music Center Pro",
    description:
      "Plataforma de gestión musical con catálogo digital, sistema de ventas y panel administrativo completo.",
    fullDescription:
      "Sistema integral para la gestión de una tienda de música que incluye catálogo de productos con búsqueda avanzada, carrito de compras, procesamiento de pedidos y panel administrativo para control de inventario, ventas y reportes en tiempo real.",
    technologies: ["React", "Node.js", "Express", "MongoDB", "Tailwind"],
    imageUrl: "/images/projects/musiccenterpro/1.png",
    icon: "/images/projects/icons/fintech.svg",
    screenshots: [
      "/images/projects/musiccenterpro/1.png",
      "/images/projects/musiccenterpro/2.png",
      "/images/projects/musiccenterpro/3.png",
    ],
    site: "https://musiccenterpro.com",
    hiddenCallout: "E-commerce",
    callout: "Gestión",
  },
  {
    id: 2,
    title: "Dashboard SaaS B2B",
    description:
      "Panel de metricas realtime con roles RBAC, facturacion stripe y export de reportes en un clic.",
    fullDescription:
      "Panel administrativo robusto para empresas B2B que permite gestionar métricas en tiempo real. Implementa un sistema de control de acceso basado en roles (RBAC), integración completa con Stripe para la facturación y herramientas de generación de reportes personalizables en múltiples formatos.",
    technologies: ["React", "TypeScript", "D3", "Node.js", "Express"],
    imageUrl: "/images/projects/saas-dashboard.jpg",
    icon: "/images/projects/icons/saas.svg",
    screenshots: [
      "/images/projects/saas-dashboard.jpg",
      "/images/projects/saas-1.jpg",
      "/images/projects/saas-2.jpg",
    ],
    site: "https://growlytics.io",
    hiddenCallout: "SaaS",
    callout: "Escala",
  },
  {
    id: 3,
    title: "Ecommerce premium",
    description:
      "Catalogo 3D con bundles inteligentes, checkout stripe, CMS headless y page builder sin codigo.",
    fullDescription:
      "Experiencia de compra de lujo con visualización de productos en 3D, sistema de bundles dinámico basado en comportamiento del usuario y un proceso de checkout optimizado. Utiliza un CMS headless para una gestión de contenidos flexible y un editor visual para que el equipo de marketing cree páginas al instante.",
    technologies: ["Next.js", "Sanity", "Stripe", "Three.js", "Framer Motion"],
    imageUrl: "/images/projects/ecommerce.jpg",
    icon: "/images/projects/icons/ecommerce.svg",
    screenshots: [
      "/images/projects/ecommerce.jpg",
      "/images/projects/ecommerce-1.jpg",
      "/images/projects/ecommerce-2.jpg",
    ],
    site: "https://luxette.com",
    hiddenCallout: "Ecommerce",
    callout: "Conversión",
  },
  {
    id: 4,
    title: "Plataforma edtech",
    description:
      "Streaming en vivo, quizzes adaptativos y panel de progreso con WebRTC y CDN global.",
    fullDescription:
      "Ecosistema educativo completo con soporte para clases en vivo de baja latencia mediante WebRTC, evaluaciones que se adaptan al nivel del estudiante y un panel analítico para monitorear el progreso académico de forma granula. Todo servido a través de una red de distribución de contenido global.",
    technologies: ["Vue.js", "Node.js", "PostgreSQL", "WebRTC", "Redis"],
    imageUrl: "/images/projects/edtech.jpg",
    icon: "/images/projects/icons/edtech.svg",
    screenshots: [
      "/images/projects/edtech.jpg",
      "/images/projects/edtech-1.jpg",
      "/images/projects/edtech-2.jpg",
    ],
    site: "https://mentorflow.ai",
    hiddenCallout: "Edtech",
    callout: "Enseñanza",
  },
  {
    id: 5,
    title: "Suite logistica",
    description:
      "Ruteo dinamico, geofencing, tracking en tiempo real y alertas push para flotas distribuidas.",
    fullDescription:
      "Solución integral para la gestión de flotas y logística de última milla. Ofrece ruteo predictivo para optimizar tiempos de entrega, perímetros virtuales (geofencing) para seguridad, seguimiento satelital en tiempo real de unidades y un sistema de notificaciones críticas push.",
    technologies: ["React Native", "Mapbox", "NestJS", "MongoDB", "RabbitMQ"],
    imageUrl: "/images/projects/logistics.jpg",
    icon: "/images/projects/icons/logistics.svg",
    screenshots: [
      "/images/projects/logistics.jpg",
      "/images/projects/logistics-1.jpg",
      "/images/projects/logistics-2.jpg",
    ],
    site: "https://cargozen.io",
    hiddenCallout: "Logistics",
    callout: "Entrega",
  },
  {
    id: 6,
    title: "Intranet corporativa",
    description:
      "SSO con Keycloak, espacios de equipos, workflows aprobatorios y bus de eventos interno.",
    fullDescription:
      "Portal centralizado para la comunicación y operatividad interna de grandes organizaciones. Facilita el inicio de sesión único (SSO), gestiona flujos de aprobación complejos, ofrece espacios colaborativos privados para departamentos y conecta servicios mediante un bus de eventos distribuido.",
    technologies: ["Angular", "GraphQL", "Keycloak", "Spring Boot", "Kafka"],
    imageUrl: "/images/projects/intranet.jpg",
    icon: "/images/projects/icons/corporate.svg",
    screenshots: [
      "/images/projects/intranet.jpg",
      "/images/projects/intranet-1.jpg",
      "/images/projects/intranet-2.jpg",
    ],
    site: "https://zenit.group",
    hiddenCallout: "Corporate",
    callout: "Unificar",
  },
];

// --- LÓGICA DE DIVISIÓN ---
// Separo los proyectos: del 0 al 5 (excluido) van al bloque CLARO
const lightProjects = projects.slice(0, 5);
// Del 5 en adelante van al bloque OSCURO
const darkProjects = projects.slice(5);

const truncate = (text: string, max = 150) =>
  text.length > max ? `${text.slice(0, max)}...` : text;
---

<section
  id="projects"
  class="w-[85%] max-w-[1800px] mx-auto py-20 xl:py-32 relative z-10"
>
  <div
    class="mb-32 border-b border-white/10 pb-8 flex flex-col xl:flex-row items-center xl:items-end justify-center xl:justify-between gap-6 projects-header-container transition-colors duration-700"
    id="projects-header"
  >
    <div>
      <h2
        class="text-xs font-bold text-left tracking-[0.3em] uppercase text-[#ffcc33] mb-4 reveal-fade-up projects-subtitle transition-colors duration-700"
        data-repeat
      >
        Ingeniería de Software
      </h2>
      <h3
        class="text-5xl xl:text-6xl font-bold text-white tracking-tight reveal-fade-up delay-100 projects-main-title transition-colors duration-700"
        data-repeat
      >
        CASOS <span
          class="text-[#25c4ff] projects-title-accent transition-colors duration-700"
          >DESTACADOS</span
        >
      </h3>
    </div>
    <p
      class="text-[#889096] max-w-sm text-sm leading-relaxed text-left reveal-fade-up delay-150 projects-description transition-colors duration-700"
      data-repeat
    >
      Trabajos seleccionados que demuestran escalabilidad, rendimiento y
      arquitectura centrada en el usuario.
    </p>
  </div>

  <div class="flex flex-col gap-16" id="project-list">
    {
      lightProjects.map((project, _) => (
        <article
          class="group relative grid grid-cols-1 xl:grid-cols-12 gap-8 xl:gap-16 items-center border-b border-black/5 pb-16 last:border-0 last:pb-0 reveal-fade-up project-card"
          data-repeat
        >
          {/* Imagen del Proyecto */}
          <div class="xl:col-span-7 order-2 xl:order-1 relative">
            <div class="relative rounded-xl overflow-hidden bg-gray-100 border border-black/5 group-hover:border-[#ffcc33]/50 transition-colors duration-500 aspect-video shadow-lg">
              <div
                class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                style={`background-image: url('${project.imageUrl}');`}
                role="img"
                aria-label={`Proyecto ${project.title}: ${project.description}`}
              />
              <div class="absolute inset-0 bg-white/10 group-hover:bg-transparent transition-colors duration-500" />
            </div>

            <div class="absolute -bottom-4 -left-4 w-24 h-24 border-l border-b border-black/5 hidden xl:block" />
            <div class="absolute -top-4 -right-4 w-24 h-24 border-r border-t border-black/5 hidden xl:block" />
          </div>

          {/* Detalles del Proyecto */}
          <div class="xl:col-span-5 order-1 xl:order-2 flex flex-col justify-center relative">
            <div class="absolute -top-24 -left-6 xl:-left-12 select-none pointer-events-none z-0">
              <span class="text-[10rem] xl:text-[12rem] font-black text-black/[0.12] leading-none project-number">
                0{project.id}
              </span>
            </div>

            <div class="relative z-10">
              <div class="flex items-center gap-4 mb-4">
                <span class="text-[#25c4ff] font-mono text-sm tracking-widest uppercase font-bold">
                  {project.hiddenCallout}
                </span>
                <div class="h-px bg-[#25c4ff] w-12" />
              </div>

              <h3 class="text-4xl xl:text-5xl font-bold text-black mb-6 leading-tight group-hover:text-gray-600 transition-colors duration-300 project-title">
                {project.title}
              </h3>

              <p class="text-[#333] text-lg leading-relaxed mb-8 font-medium project-desc">
                {project.description}
              </p>

              <div class="mb-8">
                <h4 class="text-xs font-bold uppercase tracking-widest text-[#555] mb-4">
                  Tecnologías
                </h4>
                <div class="flex flex-wrap gap-2">
                  {project.technologies.map((tech) => (
                    <span class="px-3 py-1.5 text-xs font-bold font-mono text-[#005a8c] bg-[#25c4ff]/10 border border-[#0077b5]/20 rounded">
                      {tech}
                    </span>
                  ))}
                </div>
              </div>

              <button
                type="button"
                data-project-id={project.id}
                class="inline-flex items-center gap-3 text-black font-bold uppercase tracking-widest text-sm hover:text-[#ffcc33] transition-colors group/link w-fit border-b-2 border-transparent hover:border-[#ffcc33] pb-1 project-link open-project-details cursor-pointer"
              >
                <span>Ver Detalles</span>
                <i class="fa-solid fa-arrow-right transform group-hover/link:translate-x-1 transition-transform" />
              </button>
            </div>
          </div>
        </article>
      ))
    }
    {
      darkProjects.map((project, _) => (
        <article
          class="group relative grid grid-cols-1 xl:grid-cols-12 gap-8 xl:gap-16 items-center border-b border-white/10 pb-16 last:border-0 last:pb-0 reveal-fade-up project-card dark-project"
          data-repeat
        >
          {/* Imagen (Bordes ajustados para fondo oscuro) */}
          <div class="xl:col-span-7 order-2 xl:order-1 relative">
            <div class="relative rounded-xl overflow-hidden bg-gray-900 group-hover:border-[#ffcc33]/50 transition-colors duration-500 aspect-video shadow-lg">
              <div
                class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                style={`background-image: url('${project.imageUrl}');`}
                role="img"
                aria-label={`Proyecto ${project.title}: ${project.description}`}
              />
              <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors duration-500" />
            </div>

            {/* Líneas decorativas (En blanco para fondo oscuro) */}
            <div class="absolute -bottom-4 -left-4 w-24 h-24 border-l border-b border-white/10 hidden xl:block" />
            <div class="absolute -top-4 -right-4 w-24 h-24 border-r border-t border-white/10 hidden xl:block" />
          </div>

          {/* Detalles */}
          <div class="xl:col-span-5 order-1 xl:order-2 flex flex-col justify-center relative">
            <div class="absolute -top-24 -left-6 xl:-left-12 select-none pointer-events-none z-0">
              <span class="text-[10rem] xl:text-[12rem] font-black text-white/[0.05] leading-none project-number">
                0{project.id}
              </span>
            </div>

            <div class="relative z-10">
              <div class="flex items-center gap-4 mb-4">
                <span class="text-[#25c4ff] font-mono text-sm tracking-widest uppercase font-bold">
                  {project.hiddenCallout}
                </span>
                <div class="h-px bg-[#25c4ff] w-12" />
              </div>

              <h3 class="text-4xl xl:text-5xl font-bold text-white mb-6 leading-tight group-hover:text-gray-300 transition-colors duration-300 project-title">
                {project.title}
              </h3>

              <p class="text-gray-400 text-lg leading-relaxed mb-8 font-medium project-desc">
                {project.description}
              </p>

              <div class="mb-8">
                <h4 class="text-xs font-bold uppercase tracking-widest text-gray-500 mb-4">
                  Tecnologías
                </h4>
                <div class="flex flex-wrap gap-2">
                  {project.technologies.map((tech) => (
                    <span class="px-3 py-1.5 text-xs font-bold font-mono text-[#005a8c] bg-[#25c4ff]/10 border border-[#0077b5]/20 rounded">
                      {tech}
                    </span>
                  ))}
                </div>
              </div>

              <button
                type="button"
                data-project-id={project.id}
                class="inline-flex items-center gap-3 text-white font-bold uppercase tracking-widest text-sm hover:text-[#ffcc33] transition-colors group/link w-fit border-b-2 border-transparent hover:border-[#ffcc33] pb-1 project-link open-project-details cursor-pointer"
              >
                <span>Ver Detalles</span>
                <i class="fa-solid fa-arrow-right transform group-hover/link:translate-x-1 transition-transform" />
              </button>
            </div>
          </div>
        </article>
      ))
    }
  </div>
</section>

<ProjectModal />

<div class="find-world-container w-full overflow-hidden">
  <div
    class="absolute inset-0 opacity-[0.05] pointer-events-none"
    style="background-image: radial-gradient(#25c4ff 1px, transparent 1px); background-size: 50px 50px;"
  >
  </div>

  <div
    class="absolute top-10 left-0 w-full px-4 xl:px-10 flex flex-col xl:flex-row justify-between items-center opacity-30 pointer-events-none select-none font-mono text-[8px] xl:text-[10px] tracking-widest text-[#889096] gap-2 xl:gap-0"
  >
    <div class="flex items-center gap-8">
      <div class="flex items-center gap-2">
        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
        <span>SYSTEM_ACTIVE</span>
      </div>
      <span>DC_REGION: LATAM-01</span>
      <span>UPLINK: 4.2 Gbps</span>
    </div>
    <div class="flex items-center gap-8">
      <span>CPU: 12%</span>
      <span>MEM: 4.8GB / 64GB</span>
      <span>PING: 14ms</span>
    </div>
  </div>

  <div
    class="absolute top-1/4 left-5 xl:left-10 opacity-15 font-mono text-[8px] xl:text-[9px] text-white/40 pointer-events-none select-none"
  >
    <div class="mb-2 text-white/60 font-bold">// Strategic Implementation</div>
    <div class="text-[#ffcc33]/60">async function initializeWorld() &#123;</div>
    <div class="ml-4">const world = await Fantasma.create(&#123;</div>
    <div class="ml-8">mode: 'unlimited',</div>
    <div class="ml-8">resilience: true</div>
    <div class="ml-4">&#125;);</div>
    <div class="text-[#ffcc33]/60">&#125;</div>
  </div>

  <div
    class="absolute top-1/4 right-[5%] xl:right-[15%] opacity-15 font-mono text-[8px] xl:text-[9px] text-white/40 pointer-events-none select-none"
  >
    <div class="text-[#25c4ff] mb-1">// Kotlin Microservice</div>
    <div>fun handleEvent(event: DomainEvent) &#123;</div>
    <div class="ml-2">repository.save(event.toSharedState())</div>
    <div>&#125;</div>
  </div>

  <div
    class="absolute bottom-1/4 left-[5%] xl:left-[15%] opacity-15 font-mono text-[8px] xl:text-[9px] text-white/40 pointer-events-none select-none"
  >
    <div class="text-[#65ffcd] mb-1">// C++ Performance Engine</div>
    <div>template &lt;typename T&gt;</div>
    <div>class Engine : public Singleton &#123;</div>
    <div class="ml-2">void optimize() noexcept;</div>
    <div>&#125;;</div>
  </div>

  <div
    class="absolute top-1/2 right-[2%] xl:right-[5%] opacity-10 font-mono text-[10px] xl:text-[11px] text-[#25c4ff] pointer-events-none select-none hidden sm:block transform -rotate-90"
  >
    #include &lt;express/router&gt;
  </div>

  <div
    class="absolute top-2/3 left-[2%] xl:left-[5%] opacity-10 font-mono text-[10px] xl:text-[11px] text-[#ffcc33] pointer-events-none select-none hidden sm:block transform rotate-90"
  >
    public async Task&lt;User&gt; GetProfile()
  </div>

  <div
    class="absolute inset-x-5 xl:inset-x-10 top-20 bottom-20 opacity-[0.03] pointer-events-none select-none font-mono text-[8px] xl:text-[9px] leading-relaxed"
  >
    <div class="absolute top-10 left-[10%] transform -rotate-12">
      <div class="text-[#25c4ff]">// TypeScript</div>
      <div>interface IRepository&lt;T&gt; &#123;</div>
      <div class="ml-2">findAll(): Promise&lt;T[]&gt;;</div>
      <div class="ml-2">findById(id: string): T;</div>
      <div>&#125;</div>
    </div>

    <div class="absolute top-[15%] right-[10%] transform rotate-6">
      <div class="text-[#65ffcd]">// Astro</div>
      <div>---</div>
      <div>const &#123; projects &#125; = Astro.props;</div>
      <div>---</div>
      <div>
        &lt;section&gt; &#123;projects.map(p =&gt; &lt;Card ...p /&gt;)&#125;
        &lt;/section&gt;
      </div>
    </div>

    <div class="absolute bottom-[20%] left-[5%] transform rotate-3">
      <div class="text-[#ffcc33]">// C# .NET</div>
      <div>[HttpGet]</div>
      <div>public async Task&lt;IActionResult&gt; Get() &#123;</div>
      <div class="ml-2">var data = await _service.Execute();</div>
      <div class="ml-2">return Ok(data);</div>
      <div>&#125;</div>
    </div>

    <div class="absolute bottom-[10%] right-[15%] transform -rotate-6">
      <div class="text-[#25c4ff]">// Express.js</div>
      <div>router.use((req, res, next) =&gt; &#123;</div>
      <div class="ml-2">
        logger.info(`$&#123;req.method&#125; $&#123;req.url&#125;`);
      </div>
      <div class="ml-2">next();</div>
      <div>&#125;);</div>
    </div>

    <div
      class="absolute top-1/2 left-[40%] transform -translate-x-1/2 -translate-y-1/2 opacity-20"
    >
      <div class="text-xs font-black tracking-[1em] text-white/10 uppercase">
        Distributing Logic
      </div>
    </div>
  </div>

  <div
    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[25rem] h-[25rem] bg-[#ffffff]/3 rounded-full blur-[100px] pointer-events-none"
  >
  </div>

  <div class="find-world">
    <div class="find-world-col gap-[1rem] xl:gap-[1.5rem]">
      <h2 class="find-world-title title-left">
        <span class="typing-text typing-first" data-text="Descubre un mundo"
        ></span>
        <span class="typing-caret caret-first"></span>
      </h2>
      <p class="find-world-sub">
        Diseñamos producto con research rápido, UX clara y branding que conecta
        con negocio. Todo listo para ser construido sin perder intención.
      </p>
    </div>

    <img src="logo-blanco.png" alt="Fantasma Digital" class="find-world-logo" />

    <div class="find-world-col gap-[1rem] xl:gap-[1.5rem]">
      <h2 class="find-world-title title-right">
        <span class="typing-text typing-second" data-text="de posibilidades"
        ></span>
        <span class="typing-caret caret-second"></span>
      </h2>
      <p class="find-world-sub">
        Construimos y operamos: arquitectura escalable, CI/CD, observabilidad y
        soporte de lanzamiento para que puedas crecer sin fricción.
      </p>
    </div>
  </div>

  <span
    class="absolute bottom-10 left-1/2 -translate-x-1/2 xl:translate-x-0 xl:left-auto xl:right-10 underline hover:cursor-pointer transition-all duration-300 hover:text-[#ffcc33] text-white/40 text-[10px] xl:text-xs tracking-widest uppercase font-bold z-20 w-max"
    >Contáctanos y pon tus ideas a volar</span
  >

  <div
    class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-[#040406] to-transparent pointer-events-none z-10"
  >
  </div>
</div>

<style>
  /* Global Theme Transition */
  :global(body) {
    transition:
      background-color 0.7s ease,
      color 0.7s ease;
    background-color: #040406; /* Default Dark (for Header & Title) */
    color: #f5fcff;
  }

  :global(body.theme-light) {
    background-color: #ffffff !important;
    color: #040406 !important;
  }

  /* Handle Project Card Colors when in Dark Mode (fallback or scroll out) */
  :global(body:not(.theme-light)) .project-title {
    color: #ffffff !important;
  }
  :global(body:not(.theme-light)) .project-desc {
    color: #cbd5e1 !important;
  }
  :global(body:not(.theme-light)) .project-card h4 {
    color: #9ca3af !important; /* gray-400 */
  }
  :global(body:not(.theme-light)) .project-number {
    color: rgba(255, 255, 255, 0.05) !important;
  }

  :global(body.theme-light) .project-number {
    color: rgba(0, 0, 0, 0.07) !important;
  }

  /* Puedes quitar !important aquí para controlar el color manualmente en el HTML del bloque 2 */
  :global(body:not(.theme-light)) .project-link {
    color: #ffffff !important;
  }

  /* Project Header Theme Inversion */
  :global(body.theme-light) .projects-header-container {
    border-color: rgba(4, 4, 6, 0.1) !important;
  }

  :global(body.theme-light) .projects-subtitle {
    color: #ffcc33 !important; /* Keep yellow accent */
  }

  :global(body.theme-light) .projects-main-title {
    color: #040406 !important;
  }

  :global(body.theme-light) .projects-title-accent {
    color: #25c4ff !important; /* Keep blue accent */
  }

  :global(body.theme-light) .projects-description {
    color: #666666 !important;
  }

  /* typing animation styles ... */
  .find-world-container {
    padding-top: 10vh; /* Spacer to ensure proper triggering */
    position: relative;
    min-height: 100dvh;
    display: flex;
    align-items: center;
    justify-items: center;
  }

  .find-world {
    position: absolute;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    justify-items: center;
    gap: clamp(0.65rem, 2vw, 1.2rem);
    width: min(90vw, 1200px);
    min-width: clamp(320px, 60vw, 720px);
    color: #f5fcff; /* Always white inside dark section */
    text-transform: uppercase;
    letter-spacing: 0.08em;
    text-align: center;
  }

  .find-world h2 {
    margin: 0;
    font-size: clamp(1.8rem, 5vw, 3.2rem);
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    min-width: 12ch;
    line-height: 1;
  }

  .find-world .title-left {
    justify-content: flex-end;
    margin-bottom: 1rem;
  }

  .find-world .title-right {
    justify-content: flex-start;
    margin-bottom: 1rem;
  }

  .find-world-logo {
    height: auto;
    width: clamp(80px, 12vw, 120px);
    object-fit: contain;
    aspect-ratio: 1 / 1;
    opacity: 0.35;
    filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.1));
  }

  .find-world-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .find-world-sub {
    margin: 0;
    color: #f5fcff;
    opacity: 0.7;
    line-height: 1.8;
    font-weight: 400;
    max-width: 420px;
    font-size: 0.95rem;
    letter-spacing: 0.02em;
    text-transform: none; /* Let the description be more readable */
  }

  .typing-text {
    min-height: 1em;
  }

  .typing-caret {
    width: 2px;
    height: 1.2em;
    background: currentColor;
    display: inline-block;
    margin-left: 4px;
    animation: caret-blink 0.9s steps(1) infinite;
    visibility: hidden;
  }

  @keyframes caret-blink {
    0%,
    50% {
      opacity: 1;
    }
    50.01%,
    100% {
      opacity: 0;
    }
  }

  @media (max-width: 900px) {
    .find-world {
      grid-template-columns: 1fr;
      gap: 2rem;
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      padding: 4rem 1rem;
    }
  }

  @media (max-width: 1024px) {
    .find-world {
      width: 100%;
    }
    .find-world-container {
      padding-top: 0;
    }
  }

  /* Fixes for dark project elements on light theme */
  /* --- Base Colors --- */
  :global(body.theme-light .dark-project .project-title) {
    color: #040406 !important;
  }
  :global(body.theme-light .dark-project .project-desc) {
    color: #333333 !important;
  }
  :global(body.theme-light .dark-project h4) {
    /* 'Tecnologías' heading */
    color: #555555 !important;
  }
  :global(body.theme-light .dark-project .project-link) {
    color: #040406 !important;
  }

  /* --- Borders --- */
  :global(body.theme-light .dark-project) {
    /* Article bottom border */
    border-color: rgba(0, 0, 0, 0.05) !important;
  }
  :global(body.theme-light .dark-project .border-white\/10) {
    /* Decorative & Image borders */
    border-color: rgba(0, 0, 0, 0.05) !important;
  }

  /* --- Hover States --- */
  :global(body.theme-light .dark-project:hover .project-title) {
    color: #4b5563 !important; /* gray-600, from light projects */
  }
  :global(body.theme-light .dark-project .project-link:hover) {
    color: #ffcc33 !important;
  }
  /* This selector targets the image container specifically */
  :global(body.theme-light .dark-project:hover .relative.rounded-xl) {
    border-color: rgba(255, 204, 51, 0.5) !important; /* #ffcc33/50 */
  }
</style>

<script>
  // Typing Animation Logic & Theme Transition
  const typingFirst = document.querySelector(
    ".typing-first"
  ) as HTMLElement | null;
  const typingSecond = document.querySelector(
    ".typing-second"
  ) as HTMLElement | null;
  const caretFirst = document.querySelector(
    ".caret-first"
  ) as HTMLElement | null;
  const caretSecond = document.querySelector(
    ".caret-second"
  ) as HTMLElement | null;
  const allCarets = document.querySelectorAll<HTMLElement>(".typing-caret");
  const findWorld = document.querySelector(".find-world") as HTMLElement | null;

  // Theme Triggers
  const projectList = document.querySelector(
    "#project-list"
  ) as HTMLElement | null;

  let typingCycle = 0;
  let typingInProgress = false;

  const setActiveCaret = (active: HTMLElement | null) => {
    allCarets.forEach((caret) => {
      caret.style.visibility =
        active && caret === active ? "visible" : "hidden";
    });
  };

  const typeText = (
    el: HTMLElement,
    text: string,
    speed = 85,
    pause = 180,
    cycle: number
  ) =>
    new Promise<void>((resolve) => {
      let index = 0;
      const step = () => {
        if (cycle !== typingCycle) return resolve();
        el.textContent = text.slice(0, index);
        index += 1;
        if (index <= text.length) {
          setTimeout(step, speed);
        } else {
          setTimeout(resolve, pause);
        }
      };
      step();
    });

  const resetTyping = () => {
    if (typingFirst) typingFirst.textContent = "";
    if (typingSecond) typingSecond.textContent = "";
    setActiveCaret(null);
    typingInProgress = false;
  };

  const runTypingSequence = async () => {
    if (!typingFirst || !typingSecond) return;
    if (typingInProgress) return;
    typingInProgress = true;
    const cycle = ++typingCycle;
    const firstText = typingFirst.dataset.text ?? "";
    const secondText = typingSecond.dataset.text ?? "";
    resetTyping();

    setActiveCaret(caretFirst);
    await typeText(typingFirst, firstText, 85, 180, cycle);

    if (cycle === typingCycle) {
      setActiveCaret(caretSecond);
      await typeText(typingSecond, secondText, 85, 180, cycle);
    }

    if (cycle === typingCycle) setActiveCaret(null);
    typingInProgress = false;
  };

  const handleIntersection = (entries: IntersectionObserverEntry[]) => {
    entries.forEach((entry) => {
      // Typing Logic
      if (entry.target === findWorld) {
        if (entry.isIntersecting) {
          runTypingSequence();
        } else {
          typingCycle += 1;
          resetTyping();
        }
      }

      // Main Theme Transition Logic
      // When Project List enters -> Light Mode
      if (entry.target === projectList) {
        if (entry.isIntersecting) {
          document.body.classList.add("theme-light");
        } else {
          document.body.classList.remove("theme-light");
        }
      }
    });
  };

  const isElementInViewport = (el: HTMLElement) => {
    const rect = el.getBoundingClientRect();
    return rect.top < window.innerHeight && rect.bottom > 0;
  };

  const init = () => {
    if ("IntersectionObserver" in window) {
      // ----------------------------------------------------
      // AQUÍ ESTÁ EL CAMBIO CLAVE EN ROOT MARGIN:
      // Usamos -50% (o -20%) porque ahora la lista se corta fisicamente donde queremos.
      // ----------------------------------------------------
      const projectObserver = new IntersectionObserver(handleIntersection, {
        threshold: 0,
        rootMargin: "0px 0px -95% 0px",
      });

      // Standard observer for Animations (Visibility Trigger)
      const animObserver = new IntersectionObserver(handleIntersection, {
        threshold: 0.1,
        rootMargin: "-5% 0px -20% 0px",
      });

      if (findWorld) animObserver.observe(findWorld);
      if (projectList) projectObserver.observe(projectList);

      // Initial check for load state
      if (projectList && isElementInViewport(projectList)) {
        document.body.classList.add("theme-light");
      }
    } else {
      runTypingSequence();
    }
  };

  // Modal Logic
  const initModal = () => {
    const modal = document.getElementById("project-modal");
    if (!modal) return;

    const overlay = modal.querySelector(".modal-overlay");
    const closeBtn = document.getElementById("close-modal");
    const openButtons = document.querySelectorAll(".open-project-details");

    const projectsDataEl = document.getElementById("projects-data");
    let projectData = [];
    try {
      projectData = projectsDataEl
        ? JSON.parse(projectsDataEl.textContent || "[]")
        : [];
    } catch (e) {
      console.error("Error parsing projects data:", e);
    }

    const openModal = (projectId: string) => {
      const project = projectData.find(
        (p: any) => p.id === parseInt(projectId)
      );
      if (!project) return;

      // Inject data
      const mainImage = modal.querySelector("#modal-main-image") as HTMLElement;
      if (mainImage)
        mainImage.style.backgroundImage = `url('${project.imageUrl}')`;

      const title = modal.querySelector("#modal-project-title");
      if (title) title.textContent = project.title;

      const callout = modal.querySelector("#modal-project-callout");
      if (callout) callout.textContent = project.hiddenCallout;

      const visitLink = modal.querySelector(
        "#modal-visit-link"
      ) as HTMLAnchorElement;
      if (visitLink) visitLink.href = project.site;

      const description = modal.querySelector("#modal-full-description");
      if (description) description.textContent = project.fullDescription;

      const idDisplay = modal.querySelector("#modal-project-id-display");
      if (idDisplay)
        idDisplay.textContent = `ID_PROJECT: #${project.id.toString().padStart(2, "0")}`;

      // Mini Screenshots (Desktop)
      const miniScreenshots = modal.querySelector("#modal-screenshots-mini");
      if (miniScreenshots) {
        miniScreenshots.innerHTML = project.screenshots
          .map(
            (src: string) => `
          <div class="flex-shrink-0 w-24 h-40 rounded-lg overflow-hidden bg-white/5 border border-white/10 snap-start cursor-pointer hover:border-[#25c4ff]/50 transition-colors" data-src="${src}">
            <img src="${src}" class="w-full h-full object-cover opacity-60 hover:opacity-100 transition-opacity" loading="lazy">
          </div>
        `
          )
          .join("");

        // Add listeners to thumbnails
        miniScreenshots.querySelectorAll("[data-src]").forEach((thumb) => {
          thumb.addEventListener("click", () => {
            const src = (thumb as HTMLElement).dataset.src;
            if (src && mainImage)
              mainImage.style.backgroundImage = `url('${src}')`;
          });
        });
      }

      // Mobile Screenshots Gallery
      const mobileScreenshots = modal.querySelector(
        "#modal-screenshots-mobile"
      );
      if (mobileScreenshots) {
        mobileScreenshots.innerHTML = project.screenshots
          .map(
            (src: string) => `
          <div class="flex-shrink-0 w-24 h-32 rounded-lg overflow-hidden bg-white/5 border border-white/10 snap-start cursor-pointer hover:border-[#25c4ff]/50 transition-colors" data-src="${src}">
            <img src="${src}" class="w-full h-full object-cover opacity-60 hover:opacity-100 transition-opacity" loading="lazy">
          </div>
        `
          )
          .join("");

        // Add listeners to mobile thumbnails
        mobileScreenshots.querySelectorAll("[data-src]").forEach((thumb) => {
          thumb.addEventListener("click", () => {
            const src = (thumb as HTMLElement).dataset.src;
            if (src && mainImage)
              mainImage.style.backgroundImage = `url('${src}')`;
          });
        });
      }

      // Technologies
      const techContainer = modal.querySelector("#modal-technologies");
      if (techContainer) {
        techContainer.innerHTML = project.technologies
          .map(
            (tech: string) => `
          <span class="px-4 py-2 text-[10px] font-black font-mono text-white/50 bg-white/5 border border-white/10 rounded-full hover:border-[#25c4ff]/30 hover:text-white transition-all cursor-default uppercase tracking-widest">
            ${tech}
          </span>
        `
          )
          .join("");
      }

      // Show modal
      modal.classList.add("active");
      document.body.style.overflow = "hidden";
      document.documentElement.style.overflow = "hidden";
    };

    const closeModal = () => {
      modal.classList.remove("active");
      document.body.style.overflow = "";
      document.documentElement.style.overflow = "";
    };

    openButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-project-id");
        if (id) openModal(id);
      });
    });

    closeBtn?.addEventListener("click", closeModal);
    overlay?.addEventListener("click", closeModal);

    // Close on ESC
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });
  };

  window.addEventListener("load", () => {
    init();
    initModal();
  });
</script>

<script
  id="projects-data"
  type="application/json"
  is:inline
  set:html={JSON.stringify(projects)}
/>
