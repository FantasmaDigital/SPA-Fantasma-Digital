---
import Logo from "../components/Logo.astro";
import { headerLinks } from "../constants/header";
import { socialMedia } from "../constants/social.media";

// Import styles
import "../styles/header.css";
---

<header class="w-full fixed z-[120]">
  <div
    class="p-[1.5vw] w-[90%] mx-auto flex flex-row justify-between text-white"
  >
    <div id="logo-wrapper" class="relative z-[140]">
      <div id="logo-white" class="logo-visible">
        <Logo variant="white" />
      </div>
      <div id="logo-black" class="logo-hidden">
        <Logo variant="black" />
      </div>
    </div>

    <ul class="flex flex-row gap-20 uppercase">
      {
        headerLinks.map((hl) => {
          return (
            <li class="inline-block mr-4 text-md font-semibold navbar-li link-underline li-spacing">
              <a href={hl.href}>{hl.title}</a>
            </li>
          );
        })
      }
      <li
        class="inline-block showMenuBtn menu-toggle hover:cursor-pointer mr-4 text-3xl font-semibold justify-center items-center my-auto relative"
        style="z-index:100;"
      >
        <div
          id="showMenu"
          class="m-auto flex justify-center items-center relative z-[150]"
        >
          <img
            id="plusMenu"
            src="svg/plus-svgrepo-com-wh.svg"
            class="w-6 h-6 relative z-[155] cross-fade"
          />
        </div>
      </li>
    </ul>
  </div>

  <div id="layerWhite" class="layer-white hidden flex flex-row">
    <div class="triangle-top flex flex-col">
      <ul
        class="flex flex-col w-full font-bold text-[6vw] z-20 m-auto justify-end items-start h-full pb-10"
      >
        {
          headerLinks.slice(0, 4).map((h) => (
            <li class="showMenu-link link-underline">
              <a
                href={h.href}
                class="text-[100px] text-[#040406] h-max"
                style="line-height: 128px;"
              >
                {h.title}
              </a>
            </li>
          ))
        }
      </ul>
    </div>

    <div class="triangle-bottom flex flex-col">
      <div
        class="flex flex-col h-[80%] m-auto w-full font-bold justify-start pb-[5vh] absolute bottom-0 left-0 pl-[1.5vw]"
      >
        <div
          class="grid grid-cols-1 lg:grid-cols-[1.6fr_1fr] gap-10 items-start w-full pr-[2vw]"
        >
          <div class="flex flex-col gap-6">
            <div class="flex flex-col mb-2">
              <h2 class="text-[2vw] bg-[#040406] p-2 text-white w-max rounded">
                Nuestras redes sociales
              </h2>
            </div>
            <ul class="flex flex-row gap-8 uppercase">
              {
                socialMedia.map((s) => (
                  <li class="uppercase">
                    <a
                      href={s.url}
                      target="_blank"
                      rel="noreferrer"
                      class="flex flex-row items-center gap-3 group text-[#040406]"
                    >
                      <i
                        class={`fa-brands ${s.icon} text-[1.5vw] group-hover:text-[#ffcc33] transition-all duration-300 hover:shadow-2xl`}
                      />
                      <span class="social-link link-underline">{s.name}</span>
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <span class="w-[80%] h-1 rounded-full bg-[#ffcc33] my-8"></span>

        <div class="quick-links flex flex-col gap-4">
          <h2 class="text-[2vw] bg-[#040406] p-2 text-white w-max rounded mb-2">
            Enlaces r√°pidos
          </h2>
          <ul class="flex flex-col gap-2 text-[1.4vw] font-semibold text-black">
            {
              headerLinks.map((l) => {
                return (
                  <li class="flex flex-row items-center">
                    <span class="text-[#040406] font-bold pr-2">-</span>
                    <a
                      href={l.href}
                      class="link-underline transition-all duration-300 flex flex-row gap-4"
                    >
                      {l.title}
                    </a>
                  </li>
                );
              })
            }
          </ul>
        </div>
        <p class="font-semibold text-md absolute bottom-[2vw] right-[2vw]">
          Created and Designed by Fantasma Digital
        </p>
      </div>
    </div>
  </div>
</header>

<script>
  const items = document.querySelectorAll(".navbar-li");
  const showMenu = document.querySelector("#showMenu");
  const showMenuBtn = document.querySelector(".showMenuBtn");
  const layerWhite = document.querySelector("#layerWhite");
  const plusMenu = document.querySelector("#plusMenu");

  // Variables de Logos Corregidas (seg?n la estructura de ID del HTML arriba)
  const logoBlack = document.querySelector("#logo-black");
  const logoWhite = document.querySelector("#logo-white");

  const showBlackLogo = () => {
    logoWhite?.classList.add("logo-hidden");
    logoWhite?.classList.remove("logo-visible");
    logoBlack?.classList.add("logo-visible");
    logoBlack?.classList.remove("logo-hidden");
  };

  const showWhiteLogo = () => {
    logoBlack?.classList.add("logo-hidden");
    logoBlack?.classList.remove("logo-visible");
    logoWhite?.classList.add("logo-visible");
    logoWhite?.classList.remove("logo-hidden");
  };

  const setPlusIcon = (useBlack: any) => {
    if (!(plusMenu instanceof HTMLImageElement)) return;
    plusMenu.classList.add("cross-fade-out");

    requestAnimationFrame(() => {
      plusMenu.src = useBlack
        ? "svg/plus-svgrepo-com.svg"
        : "svg/plus-svgrepo-com-wh.svg";

      requestAnimationFrame(() => {
        plusMenu.classList.remove("cross-fade-out");
      });
    });
  };

  function updateHiddenItems() {
    const scroll = window.scrollY;
    const hideCount = Math.floor(scroll / 10);

    items.forEach((el, index) => {
      if (index < hideCount) {
        el.classList.add("hidden-li");
      } else {
        el.classList.remove("hidden-li");
      }
    });
    if (hideCount > 0) {
      showMenuBtn?.classList.add("plusAnimationIn");
      showMenuBtn?.classList.remove("plusAnimationOut");
    } else {
      showMenuBtn?.classList.remove("plusAnimationIn");
      showMenuBtn?.classList.add("plusAnimationOut");
    }
  }

  function detectarPosicionComponente(selector: any) {
    const elemento = document.querySelector(selector);
    if (!elemento) return;
  }

  // Evento scroll
  document.addEventListener("scroll", updateHiddenItems);

  // Detecta al recargar la p?gina
  window.addEventListener("load", () => {
    updateHiddenItems();
    detectarPosicionComponente(".navbar");
  });

  showMenu?.addEventListener("click", () => {
    if (!layerWhite) return;
    const isOpen = !layerWhite.classList.contains("hidden");

    items.forEach((el) => el.classList.toggle("hidden-li"));

    // El icono del men? cambia de color y figura con fade
    setPlusIcon(!isOpen);

    showMenuBtn?.classList.toggle("rotate45");
    showMenuBtn?.classList.toggle("changeColor");
    showMenuBtn?.classList.toggle("open");

    const top = document.querySelector(".triangle-top");
    const bottom = document.querySelector(".triangle-bottom");

    if (!top || !bottom) {
      // Manejo de visibilidad simple si no hay elementos de transici?n
      if (!isOpen) {
        layerWhite.classList.remove("hidden");
        showBlackLogo();
        setPlusIcon(true);
      } else {
        showWhiteLogo();
        setPlusIcon(false);
        setTimeout(() => {
          layerWhite.classList.add("hidden");
        }, 500);
      }
      return;
    }

    if (!isOpen) {
      // === OPEN MENU (Fondo blanco) ===
      layerWhite.classList.remove("hidden");

      top.classList.remove("out");
      bottom.classList.remove("out");

      // OCULTAR logo BLANCO, MOSTRAR logo NEGRO
      showBlackLogo();
      setPlusIcon(true);

      // Aplica animaci?n de entrada (vertical invertida)
      top.classList.add("in");
      bottom.classList.add("in");
    } else {
      // === CLOSE MENU (Fondo oscuro) ===
      top.classList.remove("in");
      bottom.classList.remove("in");

      // Aplica animaci?n de salida (vertical invertida, saliendo)
      top.classList.add("out");
      bottom.classList.add("out");

      // MOSTRAR logo BLANCO, OCULTAR logo NEGRO
      showWhiteLogo();
      setPlusIcon(false);

      // Esperar fin de animaci?n para ocultar
      setTimeout(() => {
        layerWhite.classList.add("hidden");
      }, 600); // Debe coincidir con la duraci?n de la animaci?n de salida (0.6s)
    }
  });

  // --- LOGIC TO SWITCH LOGO COLOR ON LIGHT BACKGROUND ---
  const marqueeSection = document.getElementById("text-marquee");

  const checkHeaderContrast = () => {
    // Only check if menu is NOT open (layerWhite hidden)
    if (!layerWhite || !layerWhite.classList.contains("hidden")) return;

    // Check if body has theme-light class (from Projects section)
    const hasLightTheme = document.body.classList.contains("theme-light");

    if (hasLightTheme) {
      // Light background - use BLACK logo and cross
      showBlackLogo();
      setPlusIcon(true);

      // Update nav links to black
      document.querySelectorAll(".navbar-li a").forEach((el) => {
        (el as HTMLElement).style.color = "#040406";
      });
      return;
    }

    // Check marquee section overlap
    if (!marqueeSection) {
      // No theme-light and no marquee - use white
      showWhiteLogo();
      setPlusIcon(false);
      document.querySelectorAll(".navbar-li a").forEach((el) => {
        (el as HTMLElement).style.color = "";
      });
      return;
    }

    const navHeight = 40; // Reduced threshold for more precise switch
    const rect = marqueeSection.getBoundingClientRect();
    // Only switch to black if the marquee covers at least half of the navHeight
    const isOverlapping = rect.top <= navHeight && rect.bottom >= navHeight;

    if (isOverlapping) {
      // Marquee overlap - BLACK logo
      showBlackLogo();
      setPlusIcon(true);
      document.querySelectorAll(".navbar-li a").forEach((el) => {
        (el as HTMLElement).style.color = "#040406";
      });
    } else {
      // Default - WHITE logo
      showWhiteLogo();
      setPlusIcon(false);
      document.querySelectorAll(".navbar-li a").forEach((el) => {
        (el as HTMLElement).style.color = "";
      });
    }
  };

  // Watch for theme changes on body
  const themeObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === "class") {
        checkHeaderContrast();
      }
    });
  });

  themeObserver.observe(document.body, {
    attributes: true,
    attributeFilter: ["class"],
  });

  document.addEventListener("scroll", checkHeaderContrast);
  // Initial check
  checkHeaderContrast();
</script>
