---
type ProjectsProps = {
  projects: {
    id: number;
    title: string;
    description: string;
    technologies: string[];
    imageUrl: string;
    site: string;
    hiddenCallout?: string;
    callout: string;
  }[];
};

const projects: ProjectsProps["projects"] = [
  {
    id: 1,
    title: "Landing fintech",
    description:
      "Landing de adquisicion y onboarding KYC con variantes A/B, microcopys legales y lighthouse 95+.",
    technologies: ["Astro", "Tailwind", "GSAP"],
    imageUrl: "/images/projects/fintech-landing.jpg",
    site: "https://tuyo.app",
    hiddenCallout: "Fintech",
    callout: "Lanzamiento",
  },
  {
    id: 2,
    title: "Dashboard SaaS B2B",
    description:
      "Panel de metricas realtime con roles RBAC, facturacion stripe y export de reportes en un clic.",
    technologies: ["React", "TypeScript", "D3"],
    imageUrl: "/images/projects/saas-dashboard.jpg",
    site: "https://growlytics.io",
    hiddenCallout: "SaaS",
    callout: "Escala",
  },
  {
    id: 3,
    title: "Ecommerce premium",
    description:
      "Catalogo 3D con bundles inteligentes, checkout stripe, CMS headless y page builder sin codigo.",
    technologies: ["Next.js", "Sanity", "Stripe"],
    imageUrl: "/images/projects/ecommerce.jpg",
    site: "https://luxette.com",
    hiddenCallout: "Ecommerce",
    callout: "Conversión",
  },
  {
    id: 4,
    title: "Plataforma edtech",
    description:
      "Streaming en vivo, quizzes adaptativos y panel de progreso con WebRTC y CDN global.",
    technologies: ["Vue", "Node", "PostgreSQL"],
    imageUrl: "/images/projects/edtech.jpg",
    site: "https://mentorflow.ai",
    hiddenCallout: "Edtech",
    callout: "Enseñanza",
  },
  {
    id: 5,
    title: "Suite logistica",
    description:
      "Ruteo dinamico, geofencing, tracking en tiempo real y alertas push para flotas distribuidas.",
    technologies: ["React Native", "Mapbox", "NestJS"],
    imageUrl: "/images/projects/logistics.jpg",
    site: "https://cargozen.io",
    hiddenCallout: "Logistics",
    callout: "Entrega",
  },
  {
    id: 6,
    title: "Intranet corporativa",
    description:
      "SSO con Keycloak, espacios de equipos, workflows aprobatorios y bus de eventos interno.",
    technologies: ["Angular", "GraphQL", "Keycloak"],
    imageUrl: "/images/projects/intranet.jpg",
    site: "https://zenit.group",
    hiddenCallout: "Corporate",
    callout: "Unificar",
  },
];

const [primary, secondary, ...rest] = projects;
const truncate = (text: string, max = 150) =>
  text.length > max ? `${text.slice(0, max)}...` : text;
---

<section
  id="projects"
  class="w-[85%] max-w-[1800px] mx-auto py-32 relative z-10 border-t border-white/5"
>
  <div
    class="mb-32 border-b border-white/10 pb-8 flex flex-col md:flex-row items-end justify-between gap-6 projects-header-container transition-colors duration-700"
    id="projects-header"
  >
    <div>
      <h2
        class="text-xs font-bold tracking-[0.3em] uppercase text-[#ffcc33] mb-4 reveal-fade-up projects-subtitle transition-colors duration-700"
        data-repeat
      >
        Ingeniería de Software
      </h2>
      <h3
        class="text-4xl md:text-6xl font-bold text-white tracking-tight reveal-fade-up delay-100 projects-main-title transition-colors duration-700"
        data-repeat
      >
        CASOS <span
          class="text-[#25c4ff] projects-title-accent transition-colors duration-700"
          >DESTACADOS</span
        >
      </h3>
    </div>
    <p
      class="text-[#889096] max-w-sm text-sm leading-relaxed text-right md:text-left reveal-fade-up delay-150 projects-description transition-colors duration-700"
      data-repeat
    >
      Trabajos seleccionados que demuestran escalabilidad, rendimiento y
      arquitectura centrada en el usuario.
    </p>
  </div>

  <div class="flex flex-col gap-16" id="project-list">
    {
      projects.map((project, index) => (
        <article
          class="group relative grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16 items-center border-b border-black/5 pb-16 last:border-0 last:pb-0 reveal-fade-up project-card"
          data-repeat
        >
          {/* Project Image / Visual */}
          <div class="lg:col-span-7 order-2 lg:order-1 relative">
            <div class="relative rounded-xl overflow-hidden bg-gray-100 border border-black/5 group-hover:border-[#ffcc33]/50 transition-colors duration-500 aspect-video shadow-lg">
              <div
                class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                style={`background-image: url('${project.imageUrl}');`}
              />
              {/* Overlay for inactive state */}
              <div class="absolute inset-0 bg-white/10 group-hover:bg-transparent transition-colors duration-500" />
            </div>

            {/* Decorational "Tech" Lines */}
            <div class="absolute -bottom-4 -left-4 w-24 h-24 border-l border-b border-black/5 hidden md:block" />
            <div class="absolute -top-4 -right-4 w-24 h-24 border-r border-t border-black/5 hidden md:block" />
          </div>

          {/* Project Details */}
          <div class="lg:col-span-5 order-1 lg:order-2 flex flex-col justify-center relative">
            {/* Massive Background Number */}
            <div class="absolute -top-24 -left-12 select-none pointer-events-none z-0">
              <span class="text-[10rem] md:text-[12rem] font-black text-black/[0.12] leading-none project-number">
                0{project.id}
              </span>
            </div>

            <div class="relative z-10">
              <div class="flex items-center gap-4 mb-4">
                <span class="text-[#25c4ff] font-mono text-sm tracking-widest uppercase font-bold">
                  {project.hiddenCallout}
                </span>
                <div class="h-px bg-[#25c4ff] w-12" />
              </div>

              <h3 class="text-4xl md:text-5xl font-bold text-black mb-6 leading-tight group-hover:text-gray-600 transition-colors duration-300 project-title">
                {project.title}
              </h3>

              <p class="text-[#333] text-lg leading-relaxed mb-8 font-medium project-desc">
                {project.description}
              </p>

              <div class="mb-8">
                <h4 class="text-xs font-bold uppercase tracking-widest text-[#555] mb-4">
                  Tecnologías
                </h4>
                <div class="flex flex-wrap gap-2">
                  {project.technologies.map((tech) => (
                    <span class="px-3 py-1.5 text-xs font-bold font-mono text-[#005a8c] bg-[#25c4ff]/10 border border-[#0077b5]/20 rounded">
                      {tech}
                    </span>
                  ))}
                </div>
              </div>

              <a
                href={project.site}
                target="_blank"
                class="inline-flex items-center gap-3 text-black font-bold uppercase tracking-widest text-sm hover:text-[#ffcc33] transition-colors group/link w-fit border-b-2 border-transparent hover:border-[#ffcc33] pb-1 project-link"
              >
                <span>Ver Despliegue</span>
                <i class="fa-solid fa-arrow-right transform group-hover/link:translate-x-1 transition-transform" />
              </a>
            </div>
          </div>
        </article>
      ))
    }
  </div>
</section>

<div class="find-world-container overflow-hidden">
  <!-- Minimalist Grid Background -->
  <div
    class="absolute inset-0 opacity-[0.05] pointer-events-none"
    style="background-image: radial-gradient(#25c4ff 1px, transparent 1px); background-size: 50px 50px;"
  >
  </div>

  <!-- Top Technical Accents (System Status) -->
  <div
    class="absolute top-10 left-0 w-full px-10 flex justify-between items-center opacity-30 pointer-events-none select-none hidden md:flex font-mono text-[10px] tracking-widest text-[#889096]"
  >
    <div class="flex items-center gap-8">
      <div class="flex items-center gap-2">
        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
        <span>SYSTEM_ACTIVE</span>
      </div>
      <span>DC_REGION: LATAM-01</span>
      <span>UPLINK: 4.2 Gbps</span>
    </div>
    <div class="flex items-center gap-8">
      <span>CPU: 12%</span>
      <span>MEM: 4.8GB / 64GB</span>
      <span>PING: 14ms</span>
    </div>
  </div>

  <!-- Decorative Code Accents -->
  <div
    class="absolute top-1/4 left-10 opacity-20 font-mono text-[10px] text-[#25c4ff] pointer-events-none select-none hidden lg:block reveal-fade-in delay-300"
  >
    <div class="mb-2 text-white/60 font-bold">// Strategic Implementation</div>
    <div class="text-[#ffcc33]/60">async function initializeWorld() &#123;</div>
    <div class="ml-4">const world = await Fantasma.create(&#123;</div>
    <div class="ml-8">mode: 'unlimited',</div>
    <div class="ml-8">resilience: true</div>
    <div class="ml-4">&#125;);</div>
    <div class="text-[#ffcc33]/60">&#125;</div>
  </div>

  <!-- Technical Architecture Pillars (Software focus) -->
  <div
    class="absolute top-1/4 right-[15%] opacity-15 font-mono text-[9px] text-white/40 pointer-events-none select-none hidden lg:block"
  >
    <div class="text-[#25c4ff] mb-1">// Kotlin Microservice</div>
    <div>fun handleEvent(event: DomainEvent) &#123;</div>
    <div class="ml-2">repository.save(event.toSharedState())</div>
    <div>&#125;</div>
  </div>

  <div
    class="absolute bottom-1/4 left-[15%] opacity-15 font-mono text-[9px] text-white/40 pointer-events-none select-none hidden lg:block"
  >
    <div class="text-[#65ffcd] mb-1">// C++ Performance Engine</div>
    <div>template &lt;typename T&gt;</div>
    <div>class Engine : public Singleton &#123;</div>
    <div class="ml-2">void optimize() noexcept;</div>
    <div>&#125;;</div>
  </div>

  <div
    class="absolute top-1/2 right-[5%] opacity-10 font-mono text-[11px] text-[#25c4ff] pointer-events-none select-none hidden 2xl:block transform -rotate-90"
  >
    #include &lt;express/router&gt;
  </div>

  <div
    class="absolute top-2/3 left-[5%] opacity-10 font-mono text-[11px] text-[#ffcc33] pointer-events-none select-none hidden 2xl:block transform rotate-90"
  >
    public async Task&lt;User&gt; GetProfile()
  </div>

  <!-- Background Tech Snippets (Deep Layer) -->
  <div
    class="absolute inset-x-10 top-20 bottom-20 opacity-[0.03] pointer-events-none select-none font-mono text-[9px] leading-relaxed hidden md:block"
  >
    <div class="absolute top-10 left-[10%] transform -rotate-12">
      <div class="text-[#25c4ff]">// TypeScript</div>
      <div>interface IRepository&lt;T&gt; &#123;</div>
      <div class="ml-2">findAll(): Promise&lt;T[]&gt;;</div>
      <div class="ml-2">findById(id: string): T;</div>
      <div>&#125;</div>
    </div>

    <div class="absolute top-[15%] right-[10%] transform rotate-6">
      <div class="text-[#65ffcd]">// Astro</div>
      <div>---</div>
      <div>const &#123; projects &#125; = Astro.props;</div>
      <div>---</div>
      <div>
        &lt;section&gt; &#123;projects.map(p =&gt; &lt;Card ...p /&gt;)&#125;
        &lt;/section&gt;
      </div>
    </div>

    <div class="absolute bottom-[20%] left-[5%] transform rotate-3">
      <div class="text-[#ffcc33]">// C# .NET</div>
      <div>[HttpGet]</div>
      <div>public async Task&lt;IActionResult&gt; Get() &#123;</div>
      <div class="ml-2">var data = await _service.Execute();</div>
      <div class="ml-2">return Ok(data);</div>
      <div>&#125;</div>
    </div>

    <div class="absolute bottom-[10%] right-[15%] transform -rotate-6">
      <div class="text-[#25c4ff]">// Express.js</div>
      <div>router.use((req, res, next) =&gt; &#123;</div>
      <div class="ml-2">
        logger.info(`$&#123;req.method&#125; $&#123;req.url&#125;`);
      </div>
      <div class="ml-2">next();</div>
      <div>&#125;);</div>
    </div>

    <div
      class="absolute top-1/2 left-[40%] transform -translate-x-1/2 -translate-y-1/2 opacity-20"
    >
      <div class="text-xs font-black tracking-[1em] text-white/10 uppercase">
        Distributing Logic
      </div>
    </div>
  </div>

  <div
    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[25rem] h-[25rem] bg-[#ffffff]/3 rounded-full blur-[100px] pointer-events-none"
  >
  </div>

  <div class="find-world">
    <div class="find-world-col">
      <h2 class="find-world-title title-left">
        <span class="typing-text typing-first" data-text="Descubre un mundo"
        ></span>
        <span class="typing-caret caret-first"></span>
      </h2>
      <p class="find-world-sub">
        Diseñamos producto con research rápido, UX clara y branding que conecta
        con negocio. Todo listo para ser construido sin perder intención.
      </p>
    </div>

    <img src="logo-blanco.png" alt="Fantasma Digital" class="find-world-logo" />

    <div class="find-world-col">
      <h2 class="find-world-title title-right">
        <span class="typing-text typing-second" data-text="de posibilidades"
        ></span>
        <span class="typing-caret caret-second"></span>
      </h2>
      <p class="find-world-sub">
        Construimos y operamos: arquitectura escalable, CI/CD, observabilidad y
        soporte de lanzamiento para que puedas crecer sin fricción.
      </p>
    </div>
  </div>

  <span
    class="absolute bottom-10 left-1/2 -translate-x-1/2 md:translate-x-0 md:left-auto md:right-10 underline hover:cursor-pointer transition-all duration-300 hover:text-[#ffcc33] text-white/40 text-xs tracking-widest uppercase font-bold z-20"
    >Contáctanos y pon tus ideas a volar</span
  >

  <!-- Gradient transition to next section -->
  <div
    class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-[#040406] to-transparent pointer-events-none z-10"
  >
  </div>
</div>

<style>
  /* Global Theme Transition */
  :global(body) {
    transition:
      background-color 0.7s ease,
      color 0.7s ease;
    background-color: #040406; /* Default Dark (for Header & Title) */
    color: #f5fcff;
  }

  :global(body.theme-light) {
    background-color: #ffffff !important;
    color: #040406 !important;
  }

  /* Handle Project Card Colors when in Dark Mode (fallback or scroll out) */
  :global(body:not(.theme-light)) .project-title {
    color: #ffffff !important;
  }
  :global(body:not(.theme-light)) .project-desc {
    color: #cbd5e1 !important;
  }
  :global(body:not(.theme-light)) .project-number {
    color: rgba(255, 255, 255, 0.05) !important;
  }
  :global(body:not(.theme-light)) .project-link {
    color: #ffffff !important;
  }

  /* Project Header Theme Inversion */
  :global(body.theme-light) .projects-header-container {
    border-color: rgba(4, 4, 6, 0.1) !important;
  }

  :global(body.theme-light) .projects-subtitle {
    color: #ffcc33 !important; /* Keep yellow accent */
  }

  :global(body.theme-light) .projects-main-title {
    color: #040406 !important;
  }

  :global(body.theme-light) .projects-title-accent {
    color: #25c4ff !important; /* Keep blue accent */
  }

  :global(body.theme-light) .projects-description {
    color: #666666 !important;
  }

  /* typing animation styles ... */
  .find-world-container {
    padding-top: 10vh; /* Spacer to ensure proper triggering */
    position: relative;
    min-height: 100dvh;
    width: 100%;
    display: flex;
    align-items: center;
    justify-items: center;
  }

  .find-world {
    position: absolute;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    justify-items: center;
    gap: clamp(0.65rem, 2vw, 1.2rem);
    width: min(90vw, 1200px);
    min-width: clamp(320px, 60vw, 720px);
    color: #f5fcff; /* Always white inside dark section */
    text-transform: uppercase;
    letter-spacing: 0.08em;
    text-align: center;
  }

  .find-world h2 {
    margin: 0;
    font-size: clamp(1.8rem, 5vw, 3.2rem);
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    min-width: 12ch;
    line-height: 1;
  }

  .find-world .title-left {
    justify-content: flex-end;
    margin-bottom: 1rem;
  }

  .find-world .title-right {
    justify-content: flex-start;
    margin-bottom: 1rem;
  }

  .find-world-logo {
    height: auto;
    width: clamp(80px, 12vw, 120px);
    object-fit: contain;
    aspect-ratio: 1 / 1;
    opacity: 0.35;
    filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.1));
  }

  .find-world-col {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .find-world-sub {
    margin: 0;
    color: #f5fcff;
    opacity: 0.7;
    line-height: 1.8;
    font-weight: 400;
    max-width: 420px;
    font-size: 0.95rem;
    letter-spacing: 0.02em;
    text-transform: none; /* Let the description be more readable */
  }

  .typing-text {
    min-height: 1em;
  }

  .typing-caret {
    width: 2px;
    height: 1.2em;
    background: currentColor;
    display: inline-block;
    margin-left: 4px;
    animation: caret-blink 0.9s steps(1) infinite;
    visibility: hidden;
  }

  @keyframes caret-blink {
    0%,
    50% {
      opacity: 1;
    }
    50.01%,
    100% {
      opacity: 0;
    }
  }

  @media (max-width: 900px) {
    .find-world {
      grid-template-columns: 1fr;
      gap: 2rem;
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      padding: 4rem 1rem;
    }
  }
</style>

<script>
  // Typing Animation Logic & Theme Transition
  const typingFirst = document.querySelector(
    ".typing-first"
  ) as HTMLElement | null;
  const typingSecond = document.querySelector(
    ".typing-second"
  ) as HTMLElement | null;
  const caretFirst = document.querySelector(
    ".caret-first"
  ) as HTMLElement | null;
  const caretSecond = document.querySelector(
    ".caret-second"
  ) as HTMLElement | null;
  const allCarets = document.querySelectorAll<HTMLElement>(".typing-caret");
  const findWorld = document.querySelector(".find-world") as HTMLElement | null;

  // Theme Triggers
  const projectList = document.querySelector(
    "#project-list"
  ) as HTMLElement | null;

  let typingCycle = 0;
  let typingInProgress = false;

  const setActiveCaret = (active: HTMLElement | null) => {
    allCarets.forEach((caret) => {
      caret.style.visibility =
        active && caret === active ? "visible" : "hidden";
    });
  };

  const typeText = (
    el: HTMLElement,
    text: string,
    speed = 85,
    pause = 180,
    cycle: number
  ) =>
    new Promise<void>((resolve) => {
      let index = 0;
      const step = () => {
        if (cycle !== typingCycle) return resolve();
        el.textContent = text.slice(0, index);
        index += 1;
        if (index <= text.length) {
          setTimeout(step, speed);
        } else {
          setTimeout(resolve, pause);
        }
      };
      step();
    });

  const resetTyping = () => {
    if (typingFirst) typingFirst.textContent = "";
    if (typingSecond) typingSecond.textContent = "";
    setActiveCaret(null);
    typingInProgress = false;
  };

  const runTypingSequence = async () => {
    if (!typingFirst || !typingSecond) return;
    if (typingInProgress) return;
    typingInProgress = true;
    const cycle = ++typingCycle;
    const firstText = typingFirst.dataset.text ?? "";
    const secondText = typingSecond.dataset.text ?? "";
    resetTyping();

    setActiveCaret(caretFirst);
    await typeText(typingFirst, firstText, 85, 180, cycle);

    if (cycle === typingCycle) {
      setActiveCaret(caretSecond);
      await typeText(typingSecond, secondText, 85, 180, cycle);
    }

    if (cycle === typingCycle) setActiveCaret(null);
    typingInProgress = false;
  };

  const handleIntersection = (entries: IntersectionObserverEntry[]) => {
    entries.forEach((entry) => {
      // Typing Logic
      if (entry.target === findWorld) {
        if (entry.isIntersecting) {
          runTypingSequence();
        } else {
          typingCycle += 1;
          resetTyping();
        }
      }

      // Main Theme Transition Logic
      // When Project List enters -> Light Mode
      if (entry.target === projectList) {
        if (entry.isIntersecting) {
          document.body.classList.add("theme-light");
        } else {
          // If we scroll up past it, or down past it (handled by FindWorld?)
          // Actually, if we scroll UP, we want to remove theme-light.
          // If we scroll DOWN to FindWorld, we also want to remove theme-light.

          // Check bounding rect to see if we are above or below
          const rect = entry.boundingClientRect;
          // If top is below viewport (rect.top > window.innerHeight), we scrolled UP. remove light.
          // If bottom is above viewport (rect.bottom < 0), we scrolled DOWN. remove light.
          document.body.classList.remove("theme-light");
        }
      }
    });
  };

  const isElementInViewport = (el: HTMLElement) => {
    const rect = el.getBoundingClientRect();
    return rect.top < window.innerHeight && rect.bottom > 0;
  };

  const init = () => {
    if ("IntersectionObserver" in window) {
      // Strict observer for Color Transition (Top Trigger)
      const projectObserver = new IntersectionObserver(handleIntersection, {
        threshold: 0,
        rootMargin: "0px 0px -90% 0px",
      });

      // Standard observer for Animations (Visibility Trigger)
      const animObserver = new IntersectionObserver(handleIntersection, {
        threshold: 0.1,
        rootMargin: "-5% 0px -5% 0px",
      });

      if (findWorld) animObserver.observe(findWorld);
      if (projectList) projectObserver.observe(projectList);

      // Initial check for load state
      if (projectList && isElementInViewport(projectList)) {
        document.body.classList.add("theme-light");
      }
    } else {
      runTypingSequence();
    }
  };

  window.addEventListener("load", init);
</script>
